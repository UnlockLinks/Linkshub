const DB_URL = "https://unlocklinks-default-rtdb.firebaseio.com/links/";
    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get('id');

    let t = "#", m = "";
    const b1 = document.getElementById('b1');
    const b2 = document.getElementById('b2');
    const msg = document.getElementById('msg');
    const lBox = document.getElementById('lBox');
    const dot = document.getElementById('dot');

    // 1. Fetch data every time the page loads
    if (linkId) {
      fetch(`${DB_URL}${linkId}.json?nocache=${new Date().getTime()}`) // Added nocache param
        .then(r => r.json())
        .then(data => {
          if (data) {
            m = data.m; 
            t = data.t;
            msg.textContent = "Link authenticated.";
          }
        }).catch(() => { msg.textContent = "Connection established."; });
    }

    b1.onclick = () => {
      // 2. Force open Monetag link in a new tab immediately on click
      if (m && m !== "") {
        window.open(m, '_blank');
      }

      // UI Transitions
      b1.style.display = 'none';
      lBox.style.display = 'block';
      msg.innerHTML = "Authenticating...<br>Please wait.";

      let time = 0, limit = 3000, dash = 226;
      const timer = setInterval(() => {
        time += 50;
        dot.style.strokeDashoffset = dash - (time / limit) * dash;
        if (time >= limit) {
          clearInterval(timer);
          lBox.style.display = 'none';
          b2.disabled = false;
          b2.classList.add('active');
          msg.textContent = "Verification Successful âœ…";
        }
      }, 50);
    };

    b2.onclick = () => { 
      if (!b2.disabled && t !== "#") {
        window.location.href = t; 
      } 
    };
